<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benchmark Charts</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet">


    <style>
        [data-bs-theme="dark"] {
            --bs-body-bg: #212529;
            --bs-body-color: #f8f9fa;
        }

        [data-bs-theme="light"] {
            --bs-body-bg: #ffffff;
            --bs-body-color: #212529;
        }

        body {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            transition: background-color 0.3s, color 0.3s;
        }

        table * {
            font-size: 0.9rem;
        }

        .custom-table td,
        .custom-table th {
            /* Reduce the width of the first column */
            text-align: center;
        }
    </style>
</head>

<body data-bs-theme="light">
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center">
            <h1>Benchmark Results</h1>
            <button id="theme-toggle" class="btn btn-outline-secondary">Toggle Dark Mode</button>
        </div>

        <div id="charts"></div>
    </div>
    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>
    <script>
        const csvUrls = [
            {
                url: "https://cpp-for-everything.github.io/WebFrame/benchmark/test1.curl.csv",
                title: "Test 1: Loop to 2^n and then respond with 'Hello World'",
            },
            {
                url: "https://cpp-for-everything.github.io/WebFrame/benchmark/test2.curl.csv",
                title: "Test 2: Sum up 2^n randomly generated numbers and then respond with 'Hello World'",
            },
        ];

        async function fetchCSVData(url) {
            const response = await fetch(url);
            const csvText = await response.text();
            return new Promise((resolve) => {
                Papa.parse(csvText, {
                    complete: (results) => resolve(results.data),
                    header: false,
                });
            });
        }

        function createTable(containerId, data) {
            const tableContainer = document.getElementById(containerId);
            const table = document.createElement('table');
            table.classList.add('table', 'table-hover', 'w-100', 'table-striped', 'table-bordered', 'custom-table');

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const th_number_of_steps = document.createElement('th');
            th_number_of_steps.setAttribute("scope", "col");
            th_number_of_steps.innerHTML = "Number of steps per request";
            headerRow.appendChild(th_number_of_steps);

            data[0].forEach((header) => {
                const th = document.createElement('th');
                th.innerText = header;
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            data.slice(1).forEach((row, i) => {
                const tableRow = document.createElement('tr');
                const number_of_steps = document.createElement('td');
                number_of_steps.innerText = `2^${i}`;
                number_of_steps.setAttribute("scope", "row");
                tableRow.appendChild(number_of_steps);

                row.forEach((cell) => {
                    const td = document.createElement('td');
                    td.innerText = cell;
                    tableRow.appendChild(td);
                });
                tbody.appendChild(tableRow);
            });
            table.appendChild(tbody);

            tableContainer.appendChild(table);
        }

        let currentTheme = 'light';
        // Define color palettes for light and dark themes
        const lightModeColors = [
            `rgb(${66}, ${133}, ${244})`,
            `rgb(${219}, ${68}, ${55})`,
            `rgb(${72}, ${191}, ${181})`,
            `rgb(${244}, ${180}, ${0})`,
            `rgb(${255 - 170}, ${255 - 102}, ${255 - 204})`,
            `rgb(${220}, ${152}, ${254})`,
        ];

        const darkModeColors = [
            `rgb(${66}, ${133}, ${244})`,
            `rgb(${219}, ${68}, ${55})`,
            `rgb(${72}, ${191}, ${181})`,
            `rgb(${244}, ${180}, ${0})`,
            `rgb(${255 - 170}, ${255 - 102}, ${255 - 204})`,
            `rgb(${250}, ${250}, ${250})`,
        ];

        function createBarChart(containerId, labels, datasets, theme) {
            const isDark = theme === 'dark';
            datasets.forEach((dataset, index) => {
                dataset.backgroundColor = isDark ? darkModeColors[index % darkModeColors.length] : lightModeColors[index % lightModeColors.length];
                dataset.borderColor = isDark ? darkModeColors[index % darkModeColors.length] : lightModeColors[index % lightModeColors.length];
            });

            const ctx = document.getElementById(containerId).getContext('2d');
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets,
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'logarithmic',
                            beginAtZero: true,
                            ticks: {
                                color: isDark ? '#ffffff' : '#000000',
                            },
                            grid: {
                                color: isDark ? '#555555' : '#e0e0e0',
                            },
                        },
                        x: {
                            ticks: {
                                color: isDark ? '#ffffff' : '#000000',
                            },
                            grid: {
                                color: isDark ? '#555555' : '#e0e0e0',
                            },
                        },
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: isDark ? '#ffffff' : '#000000',
                            },
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const value = context.raw;
                                    return `${context.dataset.label}: ${value.toFixed(6)}`;
                                },
                            },
                        },
                    },
                    elements: {
                        bar: {
                            maxBarThickness: 50, // Sets the maximum width of the bars (adjust this value as needed)
                            minBarLength: 50, // Optional: Ensures bars are at least a certain length
                        },
                    },
                },
            });
        }

        function updateChartTheme(chart, theme) {
            const isDark = theme === 'dark';
            const options = chart.options;

            // Update axis ticks and grid colors
            options.scales.x.ticks.color = isDark ? '#ffffff' : '#000000';
            options.scales.x.grid.color = isDark ? '#555555' : '#e0e0e0';
            options.scales.y.ticks.color = isDark ? '#ffffff' : '#000000';
            options.scales.y.grid.color = isDark ? '#555555' : '#e0e0e0';

            // Update legend label color
            options.plugins.legend.labels.color = isDark ? '#ffffff' : '#000000';

            // Update dataset colors
            chart.data.datasets.forEach((dataset, index) => {
                dataset.backgroundColor = isDark ? darkModeColors[index % darkModeColors.length] : lightModeColors[index % lightModeColors.length];
                dataset.borderColor = isDark ? darkModeColors[index % darkModeColors.length] : lightModeColors[index % lightModeColors.length];
                console.log(dataset.backgroundColor);
            });

            // Apply changes
            chart.update();
        }

        const charts = []; // Store all chart instances

        async function generateChartAndTable(csvInfo, index) {
            const csvData = await fetchCSVData(csvInfo.url);
            csvData.pop();

            const chartsDiv = document.getElementById('charts');

            const chartTitle = document.createElement('h2');
            chartTitle.innerText = csvInfo.title;
            chartTitle.classList.add('mt-4');

            const chartContainer = document.createElement('div');
            chartContainer.classList.add('chart-container');

            const canvas = document.createElement('canvas');
            canvas.id = `chart-${index}`;
            chartContainer.appendChild(canvas);

            const tableContainer = document.createElement('div');
            tableContainer.classList.add('table-container');
            tableContainer.id = `table-${index}`;

            chartsDiv.appendChild(chartTitle);
            chartsDiv.appendChild(chartContainer);
            chartsDiv.appendChild(tableContainer);

            const labels = csvData.slice(1).map((_, i) => `2^${i}`).filter((_, i) => i % 4 == 2);
            const datasets = [];
            const columnHeaders = csvData[0];

            for (let col = 0; col < columnHeaders.length; col++) {
                if (!(["ac++-O", "ac++-O2", "c++-O", "c++-O2", "node", "python"].includes(columnHeaders[col])))
                    continue;

                const columnData = csvData.slice(1).filter((_, i) => i % 4 == 2).map((row) => Number(row[col]));
                datasets.push({
                    label: columnHeaders[col],
                    data: columnData,
                    borderWidth: 1,
                });
            }

            const chart = createBarChart(`chart-${index}`, labels, datasets, currentTheme);
            charts.push(chart);
            createTable(`table-${index}`, csvData);
        }

        (async function () {
            for (let i = 0; i < csvUrls.length; i++) {
                await generateChartAndTable(csvUrls[i], i);
            }
        })();

        const toggleButton = document.getElementById('theme-toggle');
        const body = document.body;

        toggleButton.addEventListener('click', () => {
            if (body.getAttribute('data-bs-theme') === 'light') {
                body.setAttribute('data-bs-theme', 'dark');
                toggleButton.textContent = 'Switch to Light Mode';
                charts.forEach(chart => updateChartTheme(chart, 'dark'));
            } else {
                body.setAttribute('data-bs-theme', 'light');
                toggleButton.textContent = 'Switch to Dark Mode';
                charts.forEach(chart => updateChartTheme(chart, 'light'));
            }
        });
    </script>
</body>

</html>